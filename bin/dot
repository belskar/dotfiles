#!/usr/bin/env bash

set -eu

parentDirectory="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
dotfilesDirecotry="$(cd "$(dirname "$parentDirectory")" && pwd -P)"

displayUsageAndExit() {
  echo "dot -- dotfiles management"
  echo ""
  echo "Usage: dot [options]"
  echo ""
  echo "Options:"
  echo "  -e, --edit    Open dotfiles directory for editing"
  echo "  -h, --help    Show this help message and exit"
  exit
}

while test $# -gt 0; do
  case "$1" in
  "-h" | "--help")
    displayUsageAndExit
    ;;
  "-e" | "--edit")
    exec "$EDITOR" "$dotfilesDirecotry"
    ;;
  *)
    echo "Invalid option: $1"
    displayUsageAndExit
    ;;
  esac
  shift
done

export MY_ZSH=$HOME/.dotfiles

# Update dotfiles
echo "› git pull"
if [[ "${DEBUG:-0}" == 1 ]]; then
  echo "skipping git pull - DEBUG mode"
else
  git -C $MY_ZSH pull
fi

# Set macOS defaults
$MY_ZSH/macos/set-defaults.sh

# Install homebrew
$MY_ZSH/homebrew/install.sh 2>&1

# TODO: after installation brew command is not found in shell and script is failing on brew update. Fix this
# Upgrade homebrew
echo "› brew update"
brew update

echo "› brew upgrade"
brew upgrade

# Install software
echo "› script/install"
$MY_ZSH/script/install.sh
